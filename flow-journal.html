<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#F5F3F0">
    <title>å¿ƒæµå­˜æ‘º</title>
    <link rel="manifest" href="manifest.json">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@300;400;500;600&family=Cormorant+Garamond:wght@300;400;500;600&display=swap');
        
        :root {
            --cream: #F5F3F0;
            --sand: #E8E4DF;
            --clay: #D4CEC7;
            --stone: #8B8680;
            --charcoal: #3A3632;
            --ink: #1A1816;
            --accent-sage: #9CAF88;
            --accent-warm: #C9A882;
            --shadow: rgba(26, 24, 22, 0.08);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'Noto Serif TC', serif;
            background: linear-gradient(135deg, var(--cream) 0%, var(--sand) 100%);
            color: var(--ink);
            min-height: 100vh;
            padding: 0;
            overflow-x: hidden;
        }
        
        .app-container {
            max-width: 480px;
            margin: 0 auto;
            min-height: 100vh;
            background: var(--cream);
            box-shadow: 0 0 40px var(--shadow);
        }
        
        .header {
            background: linear-gradient(135deg, var(--charcoal), var(--stone));
            color: var(--cream);
            padding: 3rem 1.5rem 2rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg width="100" height="100" xmlns="http://www.w3.org/2000/svg"><defs><pattern id="grid" width="20" height="20" patternUnits="userSpaceOnUse"><path d="M 20 0 L 0 0 0 20" fill="none" stroke="rgba(245,243,240,0.03)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
            opacity: 0.5;
        }
        
        .header h1 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 2rem;
            font-weight: 300;
            letter-spacing: 0.3em;
            position: relative;
            margin-bottom: 0.5rem;
        }
        
        .header-subtitle {
            font-size: 0.75rem;
            opacity: 0.7;
            letter-spacing: 0.2em;
            position: relative;
        }
        
        .nav {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            padding: 1.5rem;
            background: var(--cream);
        }
        
        .nav-btn {
            background: white;
            border: 1px solid var(--clay);
            padding: 1.5rem 1rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: center;
            box-shadow: 0 2px 8px var(--shadow);
        }
        
        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px var(--shadow);
            border-color: var(--accent-sage);
        }
        
        .nav-btn:active {
            transform: translateY(0);
        }
        
        .nav-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            display: block;
        }
        
        .nav-label {
            font-size: 0.85rem;
            color: var(--charcoal);
            font-weight: 500;
        }
        
        .screen {
            display: none;
            animation: fadeIn 0.4s ease-out;
        }
        
        .screen.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .form-container {
            padding: 1.5rem;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--charcoal);
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--clay);
            border-radius: 8px;
            font-family: 'Noto Serif TC', serif;
            font-size: 1rem;
            background: white;
            transition: all 0.3s ease;
        }
        
        .form-input:focus,
        .form-textarea:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--accent-sage);
            box-shadow: 0 0 0 3px rgba(156, 175, 136, 0.1);
        }
        
        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .tag {
            padding: 0.5rem 1rem;
            border: 1px solid var(--clay);
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }
        
        .tag.selected {
            background: var(--accent-sage);
            color: white;
            border-color: var(--accent-sage);
        }
        
        .context-group {
            margin-top: 0.5rem;
            padding: 1rem;
            background: var(--sand);
            border-radius: 8px;
        }
        
        .context-item {
            margin-bottom: 0.75rem;
        }
        
        .context-item:last-child {
            margin-bottom: 0;
        }
        
        .context-label {
            font-size: 0.85rem;
            color: var(--stone);
            margin-bottom: 0.25rem;
            display: block;
        }
        
        .context-input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--clay);
            border-radius: 6px;
            font-family: 'Noto Serif TC', serif;
            font-size: 0.9rem;
            background: white;
        }
        
        .slider-container {
            padding: 1rem 0;
        }
        
        .slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: var(--sand);
            outline: none;
            -webkit-appearance: none;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--accent-sage);
            cursor: pointer;
            box-shadow: 0 2px 8px var(--shadow);
        }
        
        .slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--accent-sage);
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 8px var(--shadow);
        }
        
        .slider-value {
            text-align: center;
            font-size: 2rem;
            font-weight: 500;
            color: var(--accent-sage);
            margin-top: 0.5rem;
        }
        
        .btn {
            width: 100%;
            padding: 1rem;
            border: none;
            border-radius: 12px;
            font-family: 'Noto Serif TC', serif;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 1rem;
        }
        
        .btn-primary {
            background: var(--charcoal);
            color: var(--cream);
        }
        
        .btn-primary:hover {
            background: var(--ink);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px var(--shadow);
        }
        
        .btn-secondary {
            background: var(--sand);
            color: var(--charcoal);
        }
        
        .btn-secondary:hover {
            background: var(--clay);
        }
        
        .image-upload {
            margin-top: 0.5rem;
        }
        
        .image-preview {
            width: 100%;
            max-height: 200px;
            object-fit: cover;
            border-radius: 8px;
            margin-top: 0.5rem;
            display: none;
        }
        
        .image-preview.active {
            display: block;
        }
        
        .records-container {
            padding: 1.5rem;
        }
        
        .filter-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            overflow-x: auto;
            padding-bottom: 0.5rem;
        }
        
        .filter-tab {
            padding: 0.5rem 1rem;
            border: 1px solid var(--clay);
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            white-space: nowrap;
            background: white;
            transition: all 0.3s ease;
        }
        
        .filter-tab.active {
            background: var(--charcoal);
            color: var(--cream);
            border-color: var(--charcoal);
        }
        
        .record-card {
            background: white;
            border: 1px solid var(--clay);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px var(--shadow);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .record-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px var(--shadow);
        }
        
        .record-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .record-time {
            font-size: 0.85rem;
            color: var(--stone);
        }
        
        .record-type {
            font-size: 1.5rem;
        }
        
        .record-title {
            font-size: 1rem;
            font-weight: 500;
            color: var(--charcoal);
            margin-bottom: 0.5rem;
        }
        
        .record-meta {
            font-size: 0.85rem;
            color: var(--stone);
        }
        
        .record-details {
            display: none;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--sand);
            animation: slideDown 0.3s ease-out;
        }
        
        .record-details.active {
            display: block;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .record-detail-item {
            margin-bottom: 0.75rem;
        }
        
        .record-detail-label {
            font-size: 0.8rem;
            color: var(--stone);
            margin-bottom: 0.25rem;
        }
        
        .record-detail-content {
            font-size: 0.9rem;
            color: var(--charcoal);
        }
        
        .record-image {
            width: 100%;
            border-radius: 8px;
            margin-top: 0.5rem;
        }
        
        .action-item {
            background: white;
            border: 1px solid var(--clay);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .action-item:hover {
            border-color: var(--accent-sage);
            box-shadow: 0 2px 8px var(--shadow);
        }
        
        .action-content {
            font-size: 1rem;
            color: var(--charcoal);
            margin-bottom: 0.5rem;
        }
        
        .action-stats {
            font-size: 0.85rem;
            color: var(--stone);
        }
        
        .action-usage {
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid var(--sand);
            font-size: 0.8rem;
            color: var(--stone);
        }
        
        .message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background: white;
            border: 2px solid var(--accent-sage);
            border-radius: 16px;
            padding: 2rem;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            z-index: 1000;
            max-width: 80%;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s ease;
        }
        
        .message.active {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
            pointer-events: auto;
        }
        
        .message-text {
            font-size: 1.1rem;
            color: var(--charcoal);
            margin-bottom: 1rem;
        }
        
        .message-btn {
            background: var(--accent-sage);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Noto Serif TC', serif;
            font-size: 0.9rem;
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem 1.5rem;
            color: var(--stone);
        }
        
        .empty-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        .empty-text {
            font-size: 0.9rem;
        }
        
        .back-btn {
            position: fixed;
            top: 1rem;
            left: 1rem;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid var(--clay);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            box-shadow: 0 2px 8px var(--shadow);
            z-index: 100;
            transition: all 0.3s ease;
        }
        
        .back-btn:hover {
            background: white;
            transform: scale(1.1);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <h1>å¿ƒæµå­˜æ‘º</h1>
            <div class="header-subtitle">è¨˜éŒ„æˆé•· Â· æ„ŸçŸ¥æƒ…ç·’</div>
        </div>

        <div id="homeScreen" class="screen active">
            <div class="nav">
                <button class="nav-btn" onclick="showScreen('achievementScreen')">
                    <span class="nav-icon">âœ¨</span>
                    <span class="nav-label">è¨˜éŒ„å®Œæˆ</span>
                </button>
                <button class="nav-btn" onclick="showScreen('emotionScreen')">
                    <span class="nav-icon">ğŸ’­</span>
                    <span class="nav-label">è¨˜éŒ„æƒ…ç·’</span>
                </button>
                <button class="nav-btn" onclick="showScreen('recordsScreen')">
                    <span class="nav-icon">ğŸ“–</span>
                    <span class="nav-label">æŸ¥çœ‹è¨˜éŒ„</span>
                </button>
            </div>
            
            <div style="padding: 1rem 1.5rem; background: var(--sand); border-radius: 12px; margin: 0 1.5rem; font-size: 0.85rem; color: var(--stone);">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>ğŸ“Š å·²è¨˜éŒ„ <strong id="recordCount" style="color: var(--charcoal);">0</strong> ç­†</span>
                    <span id="lastSaved" style="font-size: 0.75rem;">è¼‰å…¥ä¸­...</span>
                </div>
                <div style="margin-top: 0.5rem; font-size: 0.75rem; color: var(--stone);">
                    ğŸ’¡ æç¤ºï¼šå®šæœŸåŒ¯å‡ºå‚™ä»½,é¿å…è³‡æ–™éºå¤±
                </div>
            </div>
        </div>
      <div id="achievementScreen" class="screen">
            <button class="back-btn" onclick="showScreen('homeScreen')">â†</button>
            <div class="form-container">
                <h2 style="margin-bottom: 1.5rem; font-family: 'Cormorant Garamond', serif; font-weight: 400;">è¨˜éŒ„å®Œæˆäº‹é …</h2>
                
                <form id="achievementForm">
                    <div class="form-group">
                        <label class="form-label">æ™‚é–“</label>
                        <input type="datetime-local" id="achTime" class="form-input" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">æ¨™é¡Œ</label>
                        <input type="text" id="achTitle" class="form-input" placeholder="ä¸€å¥è©±æè¿°ä½ å®Œæˆäº†ä»€éº¼" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">åˆ†é¡</label>
                        <div class="tags-container">
                            <div class="tag" data-value="æ——è¢è¨­è¨ˆ">æ——è¢è¨­è¨ˆ</div>
                            <div class="tag" data-value="BNIæ´»å‹•">BNIæ´»å‹•</div>
                            <div class="tag" data-value="å‰µä½œ">å‰µä½œ</div>
                            <div class="tag" data-value="å…¶ä»–">å…¶ä»–</div>
                        </div>
                        <input type="hidden" id="achCategory" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ä¸Šå‚³ç…§ç‰‡ (å¯é¸)</label>
                        <input type="file" id="achImage" class="form-input image-upload" accept="image/*">
                        <img id="achImagePreview" class="image-preview" alt="é è¦½">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">å±•ç¾çš„èƒ½åŠ›</label>
                        <div class="tags-container">
                            <div class="tag" data-value="å‰µæ„">å‰µæ„</div>
                            <div class="tag" data-value="åŸ·è¡ŒåŠ›">åŸ·è¡ŒåŠ›</div>
                            <div class="tag" data-value="æºé€š">æºé€š</div>
                            <div class="tag" data-value="é ˜å°">é ˜å°</div>
                            <div class="tag" data-value="å•é¡Œè§£æ±º">å•é¡Œè§£æ±º</div>
                            <div class="tag" data-value="ç¾æ„Ÿ">ç¾æ„Ÿ</div>
                        </div>
                        <input type="hidden" id="achSkills">
                    </div>
                    
                    <button type="submit" class="btn btn-primary">å„²å­˜è¨˜éŒ„</button>
                </form>
            </div>
        </div>

        <div id="emotionScreen" class="screen">
            <button class="back-btn" onclick="showScreen('homeScreen')">â†</button>
            <div class="form-container">
                <h2 style="margin-bottom: 1.5rem; font-family: 'Cormorant Garamond', serif; font-weight: 400;">è¨˜éŒ„æƒ…ç·’æ™‚åˆ»</h2>
                
                <form id="emotionForm">
                    <div class="form-group">
                        <label class="form-label">æ™‚é–“</label>
                        <input type="datetime-local" id="emoTime" class="form-input" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">æƒ…ç·’é¡å‹</label>
                        <div class="tags-container">
                            <div class="tag" data-value="å¿«æ¨‚æ„Ÿæ©" data-icon="ğŸ˜Š" data-category="happy">ğŸ˜Š å¿«æ¨‚æ„Ÿæ©</div>
                            <div class="tag" data-value="ç„¦æ…®å¤±è½" data-icon="ğŸ˜°" data-category="anxiety">ğŸ˜° ç„¦æ…®å¤±è½</div>
                            <div class="tag" data-value="æœŸå¾…å¹³éœ" data-icon="âœ¨" data-category="mixed">âœ¨æœŸå¾…å¹³éœ</div>
                            <div class="tag" data-value="å…¶ä»–" data-icon="ğŸ’­" data-category="mixed">ğŸ’­ å…¶ä»–</div>
                        </div>
                        <input type="hidden" id="emoType" required>
                        <input type="hidden" id="emoIcon">
                        <input type="hidden" id="emoCategory">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ç™¼ç”Ÿä»€éº¼äº‹ï¼Ÿ(é¸å¡«)</label>
                        <div class="context-group">
                            <div class="context-item">
                                <span class="context-label">äºº</span>
                                <input type="text" class="context-input" id="emoPerson" placeholder="èˆ‡èª°ç›¸é—œ">
                            </div>
                            <div class="context-item">
                                <span class="context-label">åœ°</span>
                                <input type="text" class="context-input" id="emoPlace" placeholder="åœ¨å“ªè£¡">
                            </div>
                            <div class="context-item">
                                <span class="context-label">äº‹</span>
                                <textarea class="context-input" id="emoEvent" placeholder="ç™¼ç”Ÿä»€éº¼äº‹" rows="3"></textarea>
                            </div>
                            <div class="context-item">
                                <span class="context-label">å¤©æ°£</span>
                                <select class="context-input" id="emoWeather">
                                    <option value="">é¸æ“‡å¤©æ°£</option>
                                    <option value="æ™´">â˜€ï¸ æ™´</option>
                                    <option value="é™°">â˜ï¸ é™°</option>
                                    <option value="é›¨">ğŸŒ§ï¸ é›¨</option>
                                    <option value="å…¶ä»–">å…¶ä»–</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">æƒ…ç·’å¼·åº¦</label>
                        <div class="slider-container">
                            <input type="range" min="1" max="10" value="5" class="slider" id="emoIntensity">
                            <div class="slider-value" id="emoIntensityValue">5</div>
                        </div>
                    </div>
                    
                    <div id="anxietyFields" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">åœ¨æœŸå¾…ä»€éº¼å›æ‡‰ï¼Ÿ(é¸å¡«)</label>
                            <input type="text" id="emoExpectation" class="form-input" placeholder="ä¾‹å¦‚ï¼šæœŸå¾…ä½œå“ç²å¾—è®šç¾">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">å¯ä»¥åšé€™äº›äº‹ä¾†è½‰ç§»æƒ…ç·’</label>
                            <div id="suggestedActions" class="tags-container"></div>
                            <input type="text" id="customAction" class="form-input" placeholder="æˆ–è¼¸å…¥å…¶ä»–è¡Œå‹•" style="margin-top: 0.5rem;">
                            <input type="hidden" id="selectedAction">
                        </div>
                    </div>
                    
                    <div id="happyFields" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">é€™å€‹å¿«æ¨‚ä¾†æº</label>
                            <div class="tags-container">
                                <div class="tag" data-value="äºº">äºº</div>
                                <div class="tag" data-value="äº‹">äº‹</div>
                                <div class="tag" data-value="ç‰©">ç‰©</div>
                                <div class="tag" data-value="æˆå°±">æˆå°±</div>
                            </div>
                            <input type="hidden" id="happySource">
                        </div>
                        <p style="font-size: 0.85rem; color: var(--stone); margin-top: 0.5rem;">ğŸ’¡ å¤šå¯«äº›ç´°ç¯€ï¼Œæœªä¾†ç¿»é–±æ™‚æœƒæ›´æœ‰æ„Ÿå—ï¼</p>
                    </div>
                    
                    <div id="mixedFields" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">å¿«æ¨‚ä¾†æº (é¸å¡«)</label>
                            <div class="tags-container">
                                <div class="tag" data-value="äºº">äºº</div>
                                <div class="tag" data-value="äº‹">äº‹</div>
                                <div class="tag" data-value="ç‰©">ç‰©</div>
                                <div class="tag" data-value="æˆå°±">æˆå°±</div>
                            </div>
                            <input type="hidden" id="mixedHappySource">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">æ¡å–çš„è¡Œå‹• (é¸å¡«)</label>
                            <div id="mixedSuggestedActions" class="tags-container"></div>
                            <input type="text" id="mixedCustomAction" class="form-input" placeholder="æˆ–è¼¸å…¥å…¶ä»–è¡Œå‹•" style="margin-top: 0.5rem;">
                            <input type="hidden" id="mixedSelectedAction">
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">å„²å­˜è¨˜éŒ„</button>
                </form>
            </div>
        </div>

        <div id="recordsScreen" class="screen">
            <button class="back-btn" onclick="showScreen('homeScreen')">â†</button>
            <div class="records-container">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2 style="margin: 0; font-family: 'Cormorant Garamond', serif; font-weight: 400;">æŸ¥çœ‹éå¾€è¨˜éŒ„</h2>
                    <button class="btn-secondary" style="padding: 0.5rem 1rem; border-radius: 8px; border: 1px solid var(--clay); background: white; cursor: pointer; font-size: 0.85rem;" onclick="showExportMenu()">ğŸ“¥ åŒ¯å‡º</button>
                </div>
                
                <div class="filter-tabs">
                    <div class="filter-tab active" data-filter="timeline">æ™‚é–“è»¸</div>
                    <div class="filter-tab" data-filter="achievements">å®Œæˆäº‹é …</div>
                    <div class="filter-tab" data-filter="happy">å¿«æ¨‚æ„Ÿæ©</div>
                    <div class="filter-tab" data-filter="anxiety">ç„¦æ…®è¨˜éŒ„</div>
                    <div class="filter-tab" data-filter="all-emotions">æ‰€æœ‰æƒ…ç·’</div>
                    <div class="filter-tab" data-filter="actions">è¡Œå‹•å»ºè­°</div>
                </div>
                
                <div id="recordsList"></div>
            </div>
        </div>

        <div id="message" class="message">
            <div class="message-text" id="messageText"></div>
            <button class="message-btn" onclick="closeMessage()">ç¢ºå®š</button>
        </div>
        
        <div id="exportMenu" class="message">
            <div class="message-text" style="margin-bottom: 1.5rem;">è³‡æ–™ç®¡ç†</div>
            <button class="message-btn" style="margin-bottom: 0.5rem; width: 100%; background: var(--accent-sage);" onclick="exportToCSV()">ğŸ“Š åŒ¯å‡º CSV</button>
            <button class="message-btn" style="margin-bottom: 0.5rem; width: 100%; background: var(--accent-sage);" onclick="exportToJSON()">ğŸ“„ åŒ¯å‡º JSON</button>
            <button class="message-btn" style="margin-bottom: 0.5rem; width: 100%; background: var(--accent-warm);" onclick="triggerImport()">ğŸ“¥ åŒ¯å…¥è³‡æ–™</button>
            <input type="file" id="importFile" accept=".json,.csv" style="display: none;" onchange="importData(event)">
            <button class="btn-secondary" style="margin-top: 1rem; width: 100%; padding: 0.75rem; border: none; border-radius: 8px; cursor: pointer;" onclick="closeExportMenu()">å–æ¶ˆ</button>
        </div>
        
        <div id="editModal" class="message" style="max-width: 90%; max-height: 80vh; overflow-y: auto;">
            <div class="message-text" style="margin-bottom: 1.5rem; font-size: 1.2rem;">ç·¨è¼¯è¨˜éŒ„</div>
            <form id="editForm" style="text-align: left;">
                <input type="hidden" id="editRecordId">
                
                <div class="form-group">
                    <label class="form-label">æ™‚é–“</label>
                    <input type="datetime-local" id="editTime" class="form-input" required>
                </div>
                
                <div class="form-group" id="editTitleGroup">
                    <label class="form-label">æ¨™é¡Œ</label>
                    <input type="text" id="editTitle" class="form-input">
                </div>
                
                <div class="form-group" id="editEmotionGroup">
                    <label class="form-label">æƒ…ç·’å¼·åº¦</label>
                    <div class="slider-container">
                        <input type="range" min="1" max="10" value="5" class="slider" id="editIntensity">
                        <div class="slider-value" id="editIntensityValue">5</div>
                    </div>
                </div>
                
                <div class="form-group" id="editActionGroup">
                    <label class="form-label">æ¡å–çš„è¡Œå‹•</label>
                    <div id="editSuggestedActions" class="tags-container"></div>
                    <input type="text" id="editAction" class="form-input" placeholder="è¼¸å…¥è¡Œå‹•" style="margin-top: 0.5rem;">
                </div>
                
                <div class="form-group" id="editEventGroup">
                    <label class="form-label">äº‹ä»¶æè¿°</label>
                    <textarea id="editEvent" class="form-textarea" rows="3"></textarea>
                </div>
                
                <div style="display: flex; gap: 0.5rem;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">å„²å­˜</button>
                    <button type="button" class="btn-secondary" style="flex: 1;" onclick="closeEditModal()">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>

    <script>
      let records = [];
        let commonActions = [];
        
        function loadData() {
            try {
                const savedRecords = localStorage.getItem('flowJournalRecords');
                const savedActions = localStorage.getItem('flowJournalActions');
                
                if (savedRecords) {
                    records = JSON.parse(savedRecords);
                    console.log('Loaded records:', records.length);
                }
                
                if (savedActions) {
                    commonActions = JSON.parse(savedActions);
                } else {
                    commonActions = ['å»é‹å‹•', 'å†¥æƒ³', 'ç•«ç•«', 'çœ‹æ›¸', 'æ•£æ­¥', 'æ‹‰ç­‹æŒ‰æ‘©'];
                }
                
                saveToIndexedDB();
                
            } catch (error) {
                console.error('Error loading data:', error);
                loadFromIndexedDB();
            }
        }
        
        function saveData() {
            try {
                const saveTime = new Date().toISOString();
                localStorage.setItem('flowJournalRecords', JSON.stringify(records));
                localStorage.setItem('flowJournalActions', JSON.stringify(commonActions));
                localStorage.setItem('flowJournalLastSaved', saveTime);
                saveToIndexedDB();
                console.log('Data saved successfully at', saveTime);
                if (document.getElementById('recordCount')) {
                    updateDataStatus();
                }
            } catch (error) {
                console.error('Error saving data:', error);
                alert('å„²å­˜å¤±æ•—!è«‹ç«‹å³åŒ¯å‡ºå‚™ä»½ã€‚éŒ¯èª¤: ' + error.message);
            }
        }
        
        let db;
        
        function initIndexedDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('FlowJournalDB', 1);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    if (!db.objectStoreNames.contains('records')) {
                        db.createObjectStore('records', { keyPath: 'key' });
                    }
                };
            });
        }
        
        function saveToIndexedDB() {
            if (!db) return;
            
            try {
                const transaction = db.transaction(['records'], 'readwrite');
                const store = transaction.objectStore('records');
                
                store.put({ key: 'records', data: records });
                store.put({ key: 'actions', data: commonActions });
                store.put({ key: 'lastSaved', data: new Date().toISOString() });
                
                console.log('Saved to IndexedDB');
            } catch (error) {
                console.error('IndexedDB save error:', error);
            }
        }
        
        function loadFromIndexedDB() {
            if (!db) return;
            
            try {
                const transaction = db.transaction(['records'], 'readonly');
                const store = transaction.objectStore('records');
                
                const recordsRequest = store.get('records');
                const actionsRequest = store.get('actions');
                
                recordsRequest.onsuccess = () => {
                    if (recordsRequest.result) {
                        records = recordsRequest.result.data;
                        localStorage.setItem('flowJournalRecords', JSON.stringify(records));
                        console.log('Recovered from IndexedDB:', records.length, 'records');
                    }
                };
                
                actionsRequest.onsuccess = () => {
                    if (actionsRequest.result) {
                        commonActions = actionsRequest.result.data;
                        localStorage.setItem('flowJournalActions', JSON.stringify(commonActions));
                    }
                };
            } catch (error) {
                console.error('IndexedDB load error:', error);
            }
        }
        
        setInterval(() => {
            if (records.length > 0) {
                saveData();
            }
        }, 30000);
        
        window.addEventListener('beforeunload', () => {
            saveData();
        });
        
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                saveData();
            }
        });
        
        initIndexedDB().then(() => {
            loadData();
            updateDataStatus();
        }).catch(error => {
            console.error('IndexedDB init error:', error);
            loadData();
            updateDataStatus();
        });
        
        function setCurrentTime() {
            const now = new Date();
            const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000)
                .toISOString()
                .slice(0, 16);
            document.getElementById('achTime').value = localDateTime;
            document.getElementById('emoTime').value = localDateTime;
        }
        
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
            
            if (screenId === 'achievementScreen' || screenId === 'emotionScreen') {
                setCurrentTime();
            }
            
            if (screenId === 'recordsScreen') {
                renderRecords('timeline');
            }
            
            if (screenId === 'homeScreen') {
                updateDataStatus();
            }
        }
        
        function updateDataStatus() {
            document.getElementById('recordCount').textContent = records.length;
            
            const lastSavedTime = localStorage.getItem('flowJournalLastSaved');
            if (lastSavedTime) {
                const date = new Date(lastSavedTime);
                const now = new Date();
                const diffMinutes = Math.floor((now - date) / 60000);
                
                let timeStr;
                if (diffMinutes < 1) {
                    timeStr = 'å‰›å‰›å„²å­˜';
                } else if (diffMinutes < 60) {
                    timeStr = `${diffMinutes} åˆ†é˜å‰å„²å­˜`;
                } else if (diffMinutes < 1440) {
                    timeStr = `${Math.floor(diffMinutes / 60)} å°æ™‚å‰å„²å­˜`;
                } else {
                    timeStr = `${Math.floor(diffMinutes / 1440)} å¤©å‰å„²å­˜`;
                }
                
                document.getElementById('lastSaved').textContent = timeStr;
            } else {
                document.getElementById('lastSaved').textContent = 'å°šæœªå„²å­˜';
            }
        }
        
        document.querySelectorAll('.tags-container').forEach(container => {
            container.querySelectorAll('.tag').forEach(tag => {
                tag.addEventListener('click', function() {
                    const parent = this.closest('.tags-container');
                    const isMultiSelect = parent.closest('.form-group').querySelector('label').textContent.includes('èƒ½åŠ›') || 
                                          parent.closest('.form-group').querySelector('label').textContent.includes('å¿«æ¨‚ä¾†æº');
                    
                    if (!isMultiSelect) {
                        parent.querySelectorAll('.tag').forEach(t => t.classList.remove('selected'));
                    }
                    
                    this.classList.toggle('selected');
                    
                    const hiddenInput = parent.nextElementSibling;
                    if (hiddenInput && hiddenInput.type === 'hidden') {
                        if (isMultiSelect) {
                            const selected = Array.from(parent.querySelectorAll('.tag.selected'))
                                .map(t => t.dataset.value);
                            hiddenInput.value = selected.join(',');
                        } else {
                            hiddenInput.value = this.dataset.value || '';
                            if (this.dataset.icon) {
                                const iconInput = hiddenInput.nextElementSibling;
                                if (iconInput && iconInput.id.includes('Icon')) {
                                    iconInput.value = this.dataset.icon;
                                }
                            }
                            if (this.dataset.category) {
                                const categoryInput = document.getElementById('emoCategory');
                                if (categoryInput) {
                                    categoryInput.value = this.dataset.category;
                                }
                            }
                        }
                    }
                    
                    if (this.closest('#emotionForm') && this.dataset.category) {
                        const category = this.dataset.category;
                        const anxietyFields = document.getElementById('anxietyFields');
                        const happyFields = document.getElementById('happyFields');
                        const mixedFields = document.getElementById('mixedFields');
                        
                        anxietyFields.style.display = 'none';
                        happyFields.style.display = 'none';
                        mixedFields.style.display = 'none';
                        
                        if (category === 'anxiety') {
                            anxietyFields.style.display = 'block';
                            loadSuggestedActions();
                        } else if (category === 'happy') {
                            happyFields.style.display = 'block';
                        } else if (category === 'mixed') {
                            mixedFields.style.display = 'block';
                            loadMixedSuggestedActions();
                        }
                    }
                });
            });
        });
        
        document.getElementById('achImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('achImagePreview');
                    preview.src = e.target.result;
                    preview.classList.add('active');
                };
                reader.readAsDataURL(file);
            }
        });
        
        document.getElementById('emoIntensity').addEventListener('input', function() {
            document.getElementById('emoIntensityValue').textContent = this.value;
        });
        
        function loadSuggestedActions() {
            const container = document.getElementById('suggestedActions');
            container.innerHTML = '';
            
            commonActions.forEach(action => {
                const tag = document.createElement('div');
                tag.className = 'tag';
                tag.textContent = action;
                tag.addEventListener('click', function() {
                    container.querySelectorAll('.tag').forEach(t => t.classList.remove('selected'));
                    this.classList.add('selected');
                    document.getElementById('selectedAction').value = action;
                });
                container.appendChild(tag);
            });
        }
        
        function loadMixedSuggestedActions() {
            const container = document.getElementById('mixedSuggestedActions');
            container.innerHTML = '';
            
            commonActions.forEach(action => {
                const tag = document.createElement('div');
                tag.className = 'tag';
                tag.textContent = action;
                tag.addEventListener('click', function() {
                    container.querySelectorAll('.tag').forEach(t => t.classList.remove('selected'));
                    this.classList.add('selected');
                    document.getElementById('mixedSelectedAction').value = action;
                });
                container.appendChild(tag);
            });
        }
        
        document.getElementById('achievementForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const record = {
                id: Date.now(),
                type: 'achievement',
                time: document.getElementById('achTime').value,
                title: document.getElementById('achTitle').value,
                category: document.getElementById('achCategory').value,
                skills: document.getElementById('achSkills').value.split(',').filter(s => s),
                image: document.getElementById('achImagePreview').src || null
            };
            
            records.unshift(record);
            saveData();
            
            showMessage('å·²è¨˜éŒ„ã€‚æ­å–œä½ åˆé€²æ­¥äº†ä¸€å°æ­¥ï¼');
            this.reset();
            document.getElementById('achImagePreview').classList.remove('active');
            document.querySelectorAll('.tag.selected').forEach(t => t.classList.remove('selected'));
            
            setTimeout(() => showScreen('homeScreen'), 2000);
        });
        document.getElementById('emotionForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const emoType = document.getElementById('emoType').value;
            const category = document.getElementById('emoCategory').value;
            
            const record = {
                id: Date.now(),
                type: 'emotion',
                time: document.getElementById('emoTime').value,
                emotionType: emoType,
                emotionIcon: document.getElementById('emoIcon').value,
                category: category,
                intensity: document.getElementById('emoIntensity').value,
                context: {
                    person: document.getElementById('emoPerson').value,
                    place: document.getElementById('emoPlace').value,
                    event: document.getElementById('emoEvent').value,
                    weather: document.getElementById('emoWeather').value
                }
            };
            
            if (category === 'anxiety') {
                record.expectation = document.getElementById('emoExpectation').value;
                const selectedAction = document.getElementById('selectedAction').value;
                const customAction = document.getElementById('customAction').value;
                record.action = customAction || selectedAction;
                
                if (customAction && !commonActions.includes(customAction)) {
                    commonActions.push(customAction);
                }
            } 
            else if (category === 'happy') {
                record.happySource = document.getElementById('happySource').value;
            } 
            else if (category === 'mixed') {
                record.happySource = document.getElementById('mixedHappySource').value;
                const selectedAction = document.getElementById('mixedSelectedAction').value;
                const customAction = document.getElementById('mixedCustomAction').value;
                record.action = customAction || selectedAction;
                
                if (customAction && !commonActions.includes(customAction)) {
                    commonActions.push(customAction);
                }
            }
            
            records.unshift(record);
            saveData();
            
            let message = 'å·²è¨˜éŒ„ã€‚';
            if (category === 'happy') {
                message += 'è¨˜å¾—æ™‚å¸¸å›é¡§é€™äº›ç¾å¥½æ™‚åˆ»ï¼';
            } else if (category === 'anxiety') {
                message += 'è©¦è©¦çœ‹ä½ é¸æ“‡çš„è¡Œå‹•ï¼Œè¨˜å¾—ç¨å¾Œè¨˜éŒ„æ„Ÿå—è®ŠåŒ–ã€‚';
            } else {
                message += 'ä½ çš„æ¯ä¸€å€‹æ„Ÿå—éƒ½å€¼å¾—è¢«è¨˜éŒ„ã€‚';
            }
            
            showMessage(message);
            this.reset();
            document.querySelectorAll('.tag.selected').forEach(t => t.classList.remove('selected'));
            document.getElementById('anxietyFields').style.display = 'none';
            document.getElementById('happyFields').style.display = 'none';
            document.getElementById('mixedFields').style.display = 'none';
            document.getElementById('emoIntensityValue').textContent = '5';
            
            setTimeout(() => showScreen('homeScreen'), 2500);
        });
        
        document.querySelectorAll('.filter-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                renderRecords(this.dataset.filter);
            });
        });
        
        function renderRecords(filter) {
            const container = document.getElementById('recordsList');
            container.innerHTML = '';
            
            let filteredRecords = records;
            
            if (filter === 'achievements') {
                filteredRecords = records.filter(r => r.type === 'achievement');
            } else if (filter === 'happy') {
                filteredRecords = records.filter(r => 
                    r.type === 'emotion' && r.category === 'happy'
                );
            } else if (filter === 'anxiety') {
                filteredRecords = records.filter(r => 
                    r.type === 'emotion' && r.category === 'anxiety'
                );
            } else if (filter === 'all-emotions') {
                filteredRecords = records.filter(r => r.type === 'emotion');
            } else if (filter === 'actions') {
                renderActions();
                return;
            }
            
            if (filteredRecords.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ“</div>
                        <div class="empty-text">é‚„æ²’æœ‰è¨˜éŒ„<br>é–‹å§‹è¨˜éŒ„ä½ çš„æˆé•·èˆ‡æƒ…ç·’å§ï¼</div>
                    </div>
                `;
                return;
            }
            
            filteredRecords.forEach(record => {
                const card = createRecordCard(record);
                container.appendChild(card);
            });
        }
        
        function createRecordCard(record) {
            const card = document.createElement('div');
            card.className = 'record-card';
            
            const date = new Date(record.time);
            const timeStr = `${date.getMonth() + 1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
            
            if (record.type === 'achievement') {
                card.innerHTML = `
                    <div class="record-header">
                        <span class="record-time">${timeStr}</span>
                        <div>
                            <span class="record-type">âœ¨</span>
                            <button onclick="editRecord(${record.id}); event.stopPropagation();" style="margin-left: 0.5rem; background: var(--sand); border: 1px solid var(--clay); border-radius: 6px; padding: 0.25rem 0.5rem; cursor: pointer; font-size: 0.8rem;">âœï¸</button>
                        </div>
                    </div>
                    <div class="record-title">${record.title}</div>
                    <div class="record-meta">${record.category} Â· ${record.skills.join(' Â· ')}</div>
                    <div class="record-details">
                        ${record.image ? `<img src="${record.image}" class="record-image" alt="è¨˜éŒ„åœ–ç‰‡">` : ''}
                        <div class="record-detail-item">
                            <div class="record-detail-label">åˆ†é¡</div>
                            <div class="record-detail-content">${record.category}</div>
                        </div>
                        <div class="record-detail-item">
                            <div class="record-detail-label">å±•ç¾èƒ½åŠ›</div>
                            <div class="record-detail-content">${record.skills.join('ã€')}</div>
                        </div>
                    </div>
                `;
            } else {
                const contextParts = [];
                if (record.context.person) contextParts.push(`ğŸ‘¤ ${record.context.person}`);
                if (record.context.place) contextParts.push(`ğŸ“ ${record.context.place}`);
                if (record.context.weather) contextParts.push(`${record.context.weather}`);
                
                card.innerHTML = `
                    <div class="record-header">
                        <span class="record-time">${timeStr}</span>
                        <div>
                            <span class="record-type">${record.emotionIcon}</span>
                            <button onclick="editRecord(${record.id}); event.stopPropagation();" style="margin-left: 0.5rem; background: var(--sand); border: 1px solid var(--clay); border-radius: 6px; padding: 0.25rem 0.5rem; cursor: pointer; font-size: 0.8rem;">âœï¸</button>
                        </div>
                    </div>
                    <div class="record-title">${record.emotionType} Â· å¼·åº¦ ${record.intensity}</div>
                    ${contextParts.length > 0 ? `<div class="record-meta">${contextParts.join(' Â· ')}</div>` : ''}
                    <div class="record-details">
                        ${record.context.event ? `
                            <div class="record-detail-item">
                                <div class="record-detail-label">äº‹ä»¶</div>
                                <div class="record-detail-content">${record.context.event}</div>
                            </div>
                        ` : ''}
                        ${record.expectation ? `
                            <div class="record-detail-item">
                                <div class="record-detail-label">æœŸå¾…</div>
                                <div class="record-detail-content">${record.expectation}</div>
                            </div>
                        ` : ''}
                        ${record.action ? `
                            <div class="record-detail-item">
                                <div class="record-detail-label">æ¡å–è¡Œå‹•</div>
                                <div class="record-detail-content">${record.action}</div>
                            </div>
                        ` : ''}
                        ${record.happySource ? `
                            <div class="record-detail-item">
                                <div class="record-detail-label">å¿«æ¨‚ä¾†æº</div>
                                <div class="record-detail-content">${record.happySource}</div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            
            card.addEventListener('click', function(e) {
                if (e.target.tagName === 'BUTTON') return;
                const details = this.querySelector('.record-details');
                details.classList.toggle('active');
            });
            
            return card;
        }
        
        function renderActions() {
            const container = document.getElementById('recordsList');
            container.innerHTML = '';
            
            const actionStats = {};
            records.forEach(record => {
                if (record.action) {
                    if (!actionStats[record.action]) {
                        actionStats[record.action] = {
                            count: 0,
                            contexts: []
                        };
                    }
                    actionStats[record.action].count++;
                    actionStats[record.action].contexts.push({
                        time: record.time,
                        context: record.context.event || record.expectation || 'ç„¦æ…®æ™‚åˆ»'
                    });
                }
            });
            
            if (Object.keys(actionStats).length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ¯</div>
                        <div class="empty-text">é‚„æ²’æœ‰è¡Œå‹•è¨˜éŒ„<br>ä¸‹æ¬¡ç„¦æ…®æ™‚è©¦è‘—è¨˜éŒ„ä½ çš„è¡Œå‹•å§ï¼</div>
                    </div>
                `;
                return;
            }
            
            const sortedActions = Object.entries(actionStats)
                .sort((a, b) => b[1].count - a[1].count);
            
            sortedActions.forEach(([action, stats]) => {
                const item = document.createElement('div');
                item.className = 'action-item';
                
                const contextsHtml = stats.contexts.slice(0, 3).map(c => {
                    const date = new Date(c.time);
                    const dateStr = `${date.getMonth() + 1}/${date.getDate()}`;
                    return `<div>${dateStr}: ${c.context}</div>`;
                }).join('');
                
                item.innerHTML = `
                    <div class="action-content">${action}</div>
                    <div class="action-stats">ä½¿ç”¨æ¬¡æ•¸: ${stats.count}</div>
                    <div class="action-usage">
                        <div style="margin-bottom: 0.25rem; font-weight: 500;">ä½¿ç”¨æƒ…å¢ƒ:</div>
                        ${contextsHtml}
                        ${stats.contexts.length > 3 ? `<div style="margin-top: 0.25rem;">...é‚„æœ‰ ${stats.contexts.length - 3} æ¬¡</div>` : ''}
                    </div>
                `;
                
                container.appendChild(item);
            });
        }
        
        function showMessage(text) {
            document.getElementById('messageText').textContent = text;
            document.getElementById('message').classList.add('active');
        }
        
        function closeMessage() {
            document.getElementById('message').classList.remove('active');
        }
        
        function showExportMenu() {
            document.getElementById('exportMenu').classList.add('active');
        }
        
        function closeExportMenu() {
            document.getElementById('exportMenu').classList.remove('active');
        }
        
        function triggerImport() {
            document.getElementById('importFile').click();
        }
        
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    let importedRecords = [];
                    
                    if (file.name.endsWith('.json')) {
                        const data = JSON.parse(e.target.result);
                        importedRecords = data.records || data;
                    }
                    
                    if (importedRecords.length === 0) {
                        showMessage('æ²’æœ‰æ‰¾åˆ°å¯åŒ¯å…¥çš„è¨˜éŒ„');
                        closeExportMenu();
                        return;
                    }
                    
                    const existingIds = new Set(records.map(r => r.id));
                    const newRecords = importedRecords.filter(r => !existingIds.has(r.id));
                    
                    records = [...records, ...newRecords];
                    records.sort((a, b) => new Date(b.time) - new Date(a.time));
                    
                    saveData();
                    
                    closeExportMenu();
                    showMessage(`æˆåŠŸåŒ¯å…¥ ${newRecords.length} ç­†è¨˜éŒ„ï¼\n(è·³é ${importedRecords.length - newRecords.length} ç­†é‡è¤‡è¨˜éŒ„)`);
                    
                    if (document.getElementById('recordsScreen').classList.contains('active')) {
                        const activeTab = document.querySelector('.filter-tab.active');
                        if (activeTab) {
                            renderRecords(activeTab.dataset.filter);
                        }
                    }
                } catch (error) {
                    console.error('Import error:', error);
                    showMessage('åŒ¯å…¥å¤±æ•—ï¼šæª”æ¡ˆæ ¼å¼ä¸æ­£ç¢º');
                    closeExportMenu();
                }
            };
            
            reader.readAsText(file);
            event.target.value = '';
        }
        
        function editRecord(recordId) {
            const record = records.find(r => r.id === recordId);
            if (!record) return;
            
            document.getElementById('editRecordId').value = record.id;
            document.getElementById('editTime').value = record.time;
            
            if (record.type === 'achievement') {
                document.getElementById('editTitleGroup').style.display = 'block';
                document.getElementById('editEmotionGroup').style.display = 'none';
                document.getElementById('editActionGroup').style.display = 'none';
                document.getElementById('editEventGroup').style.display = 'none';
                
                document.getElementById('editTitle').value = record.title;
            } else {
                document.getElementById('editTitleGroup').style.display = 'none';
                document.getElementById('editEmotionGroup').style.display = 'block';
                document.getElementById('editEventGroup').style.display = 'block';
                
                document.getElementById('editIntensity').value = record.intensity;
                document.getElementById('editIntensityValue').textContent = record.intensity;
                document.getElementById('editEvent').value = record.context.event || '';
                
                if (record.action || record.category === 'anxiety' || record.category === 'mixed') {
                    document.getElementById('editActionGroup').style.display = 'block';
                    document.getElementById('editAction').value = record.action || '';
                    
                    const container = document.getElementById('editSuggestedActions');
                    container.innerHTML = '';
                    commonActions.forEach(action => {
                        const tag = document.createElement('div');
                        tag.className = 'tag';
                        if (action === record.action) {
                            tag.classList.add('selected');
                        }
                        tag.textContent = action;
                        tag.addEventListener('click', function() {
                            container.querySelectorAll('.tag').forEach(t => t.classList.remove('selected'));
                            this.classList.add('selected');
                            document.getElementById('editAction').value = action;
                        });
                        container.appendChild(tag);
                    });
                } else {
                    document.getElementById('editActionGroup').style.display = 'none';
                }
            }
            
            document.getElementById('editModal').classList.add('active');
        }
        
        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
        }
        
        document.getElementById('editIntensity').addEventListener('input', function() {
            document.getElementById('editIntensityValue').textContent = this.value;
        });
        
        document.getElementById('editForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const recordId = parseInt(document.getElementById('editRecordId').value);
            const recordIndex = records.findIndex(r => r.id === recordId);
            
            if (recordIndex === -1) return;
            
            const record = records[recordIndex];
            record.time = document.getElementById('editTime').value;
            
            if (record.type === 'achievement') {
                record.title = document.getElementById('editTitle').value;
            } else {
                record.intensity = document.getElementById('editIntensity').value;
                record.context.event = document.getElementById('editEvent').value;
                
                if (document.getElementById('editActionGroup').style.display !== 'none') {
                    const newAction = document.getElementById('editAction').value;
                    record.action = newAction;
                    
                    if (newAction && !commonActions.includes(newAction)) {
                        commonActions.push(newAction);
                    }
                }
            }
            
            records.sort((a, b) => new Date(b.time) - new Date(a.time));
            
            saveData();
            
            closeEditModal();
            showMessage('è¨˜éŒ„å·²æ›´æ–°ï¼');
            
            const activeTab = document.querySelector('.filter-tab.active');
            if (activeTab) {
                renderRecords(activeTab.dataset.filter);
            }
        });
        
        function exportToCSV() {
            if (records.length === 0) {
                showMessage('ç›®å‰æ²’æœ‰è¨˜éŒ„å¯ä»¥åŒ¯å‡º');
                closeExportMenu();
                return;
            }
            
            let csv = '\uFEFF';
            csv += 'æ—¥æœŸ,æ™‚é–“,é¡å‹,æ¨™é¡Œ/æƒ…ç·’,åˆ†é¡/å¼·åº¦,è©³ç´°å…§å®¹,äºº,åœ°,å¤©æ°£,èƒ½åŠ›æ¨™ç±¤,æœŸå¾…,æ¡å–è¡Œå‹•,å¿«æ¨‚ä¾†æº\n';
            
            records.forEach(record => {
                const date = new Date(record.time);
                const dateStr = `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')}`;
                const timeStr = `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
                
                if (record.type === 'achievement') {
                    csv += `"${dateStr}","${timeStr}","å®Œæˆäº‹é …","${record.title}","${record.category}","","","","","${record.skills.join('ã€')}","","",""\n`;
                } else {
                    const event = (record.context.event || '').replace(/"/g, '""');
                    csv += `"${dateStr}","${timeStr}","æƒ…ç·’è¨˜éŒ„","${record.emotionType}","${record.intensity}","${event}","${record.context.person || ''}","${record.context.place || ''}","${record.context.weather || ''}","","${record.expectation || ''}","${record.action || ''}","${record.happySource || ''}"\n`;
                }
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `å¿ƒæµå­˜æ‘º_${new Date().toISOString().slice(0, 10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            closeExportMenu();
            showMessage('CSV æª”æ¡ˆå·²ä¸‹è¼‰ï¼å¯ä»¥ç”¨ Excel æˆ– Google Sheets é–‹å•Ÿ');
        }
        
        function exportToJSON() {
            if (records.length === 0) {
                showMessage('ç›®å‰æ²’æœ‰è¨˜éŒ„å¯ä»¥åŒ¯å‡º');
                closeExportMenu();
                return;
            }
            
            const exportData = {
                exportDate: new Date().toISOString(),
                totalRecords: records.length,
                records: records
            };
            
            const json = JSON.stringify(exportData, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `å¿ƒæµå­˜æ‘º_${new Date().toISOString().slice(0, 10)}.json`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            closeExportMenu();
            showMessage('JSON æª”æ¡ˆå·²ä¸‹è¼‰ï¼å¯ä»¥ç”¨ä¾†å‚™ä»½æˆ–åŒ¯å…¥ Notion');
        }
        
        setCurrentTime();
    </script>
</body>
</html>
